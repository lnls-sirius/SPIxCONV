#!/usr/bin/python3

from Adafruit_BBIO.SPI import SPI
import Adafruit_BBIO.GPIO as GPIO
import init
import selection
import dac
import adc
import sys
import math
import time
import matplotlib.pyplot as plt

v1 = [52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52429,52612,52796,52979,53163,53346,53530,53713,53897,54080,54264,54447,54631,54814,54998,55181,55365,55548,55732,55915,56099,56282,56466,56649,56833,57016,57200,57383,57567,57750,57934,58117,58301,58484,58668,58851,59035,59218,59402,59585,59769,59952,60136,60319,60503,60686,60870,61053,61237,61420,61604,61787,61971,62154,62338,62521,62705,62888,63072,63255,63439,63622,63806,63989,64173,64356,64540,64723,64907,65090,65274,65457,65641,65824,66008,66191,66375,66558,66742,66925,67109,67292,67476,67659,67843,68026,68210,68393,68577,68760,68944,69127,69311,69494,69678,69861,70045,70228,70412,70595,70779,70962,71146,71329,71513,71696,71880,72063,72247,72430,72614,72797,72981,73164,73348,73531,73715,73898,74082,74265,74449,74632,74816,74999,75183,75366,75550,75733,75917,76100,76284,76467,76651,76834,77018,77201,77385,77568,77752,77935,78119,78302,78486,78669,78853,79036,79220,79403,79587,79770,79954,80137,80321,80504,80688,80871,81055,81238,81422,81605,81789,81972,82156,82339,82523,82706,82890,83073,83257,83440,83624,83807,83991,84174,84358,84541,84725,84908,85092,85275,85459,85642,85826,86009,86193,86376,86560,86743,86927,87110,87294,87477,87661,87844,88028,88211,88395,88578,88762,88945,89129,89312,89496,89679,89863,90046,90230,90413,90597,90780,90964,91147,91331,91514,91698,91881,92065,92248,92432,92615,92799,92982,93166,93349,93533,93716,93900,94083,94267,94450,94634,94817,95001,95184,95368,95551,95735,95918,96102,96285,96469,96652,96836,97019,97203,97386,97570,97753,97937,98120,98304,98488,98671,98855,99038,99222,99405,99589,99772,99956,100139,100323,100506,100690,100873,101057,101240,101424,101607,101791,101974,102158,102341,102525,102708,102892,103075,103259,103442,103626,103809,103993,104176,104360,104543,104727,104910,105094,105277,105461,105644,105828,106011,106195,106378,106562,106745,106929,107112,107296,107479,107663,107846,108030,108213,108397,108580,108764,108947,109131,109314,109498,109681,109865,110048,110232,110415,110599,110782,110966,111149,111333,111516,111700,111883,112067,112250,112434,112617,112801,112984,113168,113351,113535,113718,113902,114085,114269,114452,114636,114819,115003,115186,115370,115553,115737,115920,116104,116287,116471,116654,116838,117021,117205,117388,117572,117755,117939,118122,118306,118489,118673,118856,119040,119223,119407,119590,119774,119957,120141,120324,120508,120691,120875,121058,121242,121425,121609,121792,121976,122159,122343,122526,122710,122893,123077,123260,123444,123627,123811,123994,124178,124361,124545,124728,124912,125095,125279,125462,125646,125829,126013,126196,126380,126563,126747,126930,127114,127297,127481,127664,127848,128031,128215,128398,128582,128765,128949,129132,129316,129499,129683,129866,130050,130233,130417,130600,130784,130967,131151,131334,131518,131701,131885,132068,132252,132435,132619,132802,132986,133169,133353,133536,133720,133903,134087,134270,134454,134637,134821,135004,135188,135371,135555,135738,135922,136105,136289,136472,136656,136839,137023,137206,137390,137573,137757,137940,138124,138307,138491,138674,138858,139041,139225,139408,139592,139775,139959,140142,140326,140509,140693,140876,141060,141243,141427,141610,141794,141977,142161,142344,142528,142711,142895,143078,143262,143445,143629,143812,143996,144179,144363,144546,144730,144913,145097,145280,145464,145647,145831,146014,146198,146381,146565,146748,146932,147115,147299,147482,147666,147849,148033,148216,148400,148583,148767,148950,149134,149317,149501,149684,149868,150051,150235,150418,150602,150785,150969,151152,151336,151519,151703,151886,152070,152253,152437,152620,152804,152987,153171,153354,153538,153721,153905,154088,154272,154455,154639,154822,155006,155189,155373,155556,155740,155923,156107,156290,156474,156657,156841,157024,157208,157391,157575,157758,157942,158125,158309,158492,158676,158859,159043,159226,159410,159593,159777,159960,160144,160327,160511,160694,160878,161061,161245,161428,161612,161795,161979,162162,162346,162529,162713,162896,163080,163263,163447,163630,163814,163997,164181,164364,164548,164731,164915,165098,165282,165465,165649,165832,166016,166199,166383,166566,166750,166933,167117,167300,167484,167667,167851,168034,168218,168401,168585,168768,168952,169135,169319,169502,169686,169869,170053,170236,170420,170603,170787,170970,171154,171337,171521,171704,171888,172071,172255,172438,172622,172805,172989,173172,173356,173539,173723,173906,174090,174273,174457,174640,174824,175007,175191,175374,175558,175741,175925,176108,176292,176475,176659,176842,177026,177209,177393,177576,177760,177943,178127,178310,178494,178677,178861,179044,179228,179411,179595,179778,179962,180145,180329,180512,180696,180879,181063,181246,181430,181613,181797,181980,182164,182347,182531,182714,182898,183081,183265,183448,183632,183815,183999,184182,184366,184549,184733,184916,185100,185283,185467,185650,185834,186017,186201,186384,186568,186751,186935,187118,187302,187485,187669,187852,188036,188219,188403,188586,188770,188953,189137,189320,189504,189687,189871,190054,190238,190421,190605,190788,190972,191155,191339,191522,191706,191889,192073,192256,192440,192623,192807,192990,193174,193357,193541,193724,193908,194091,194275,194458,194642,194825,195009,195192,195376,195559,195743,195926,196110,196293,196477,196660,196844,197027,197211,197394,197578,197761,197945,198128,198312,198495,198679,198862,199046,199229,199413,199596,199780,199963,200147,200330,200514,200697,200881,201064,201248,201431,201615,201798,201982,202165,202349,202532,202716,202899,203083,203266,203450,203633,203817,204000,204184,204367,204551,204734,204918,205101,205285,205468,205652,205835,206019,206202,206386,206569,206753,206936,207120,207303,207487,207670,207854,208037,208221,208404,208588,208771,208955,209138,209322,209505,209689,209872,210056,210239,210423,210606,210790,210973,211157,211340,211524,211707,211891,212074,212258,212441,212625,212808,212992,213176,213359,213543,213726,213910,214093,214277,214460,214644,214827,215011,215194,215378,215561,215745,215928,216112,216295,216479,216662,216846,217029,217213,217396,217580,217763,217947,218130,218314,218497,218681,218864,219048,219231,219415,219598,219782,219965,220149,220332,220516,220699,220883,221066,221250,221433,221617,221800,221984,222167,222351,222534,222718,222901,223085,223268,223452,223635,223819,224002,224186,224369,224553,224736,224920,225103,225287,225470,225654,225837,226021,226204,226388,226571,226755,226938,227122,227305,227489,227672,227856,228039,228223,228406,228590,228773,228957,229140,229324,229507,229691,229874,230058,230241,230425,230608,230792,230975,231159,231342,231526,231709,231893,232076,232260,232443,232627,232810,232994,233177,233361,233544,233728,233911,234095,234278,234462,234645,234829,235012,235196,235379,235563,235746,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235930,235091,234252,233413,232574,231735,230896,230058,229219,228380,227541,226702,225863,225024,224186,223347,222508,221669,220830,219991,219152,218314,217475,216636,215797,214958,214119,213280,212441,211603,210764,209925,209086,208247,207408,206569,205731,204892,204053,203214,202375,201536,200697,199859,199020,198181,197342,196503,195664,194825,193987,193148,192309,191470,190631,189792,188953,188115,187276,186437,185598,184759,183920,183081,182243,181404,180565,179726,178887,178048,177209,176370,175532,174693,173854,173015,172176,171337,170498,169660,168821,167982,167143,166304,165465,164626,163788,162949,162110,161271,160432,159593,158754,157916,157077,156238,155399,154560,153721,152882,152044,151205,150366,149527,148688,147849,147010,146171,145333,144494,143655,142816,141977,141138,140299,139461,138622,137783,136944,136105,135266,134427,133589,132750,131911,131072,130233,129394,128555,127717,126878,126039,125200,124361,123522,122683,121845,121006,120167,119328,118489,117650,116811,115973,115134,114295,113456,112617,111778,110939,110100,109262,108423,107584,106745,105906,105067,104228,103390,102551,101712,100873,100034,99195,98356,97518,96679,95840,95001,94162,93323,92484,91646,90807,89968,89129,88290,87451,86612,85774,84935,84096,83257,82418,81579,80740,79901,79063,78224,77385,76546,75707,74868,74029,73191,72352,71513,70674,69835,68996,68157,67319,66480,65641,64802,63963,63124,62285,61447,60608,59769,58930,58091,57252,56413,55575,54736,53897,53058,52219,51380,50541,49703,48864,48025,47186,46347,45508,44669,43830,42992,42153,41314,40475,39636,38797,37958,37120,36281,35442,34603,33764,32925,32086,31248,30409,29570,28731,27892,27053,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322,39322]

#=======================================================
# follow ramp waveform (write in DAC and read with ADC)
#=======================================================
def test1(board):
    # import time to define the name of the output file
    from time import gmtime, strftime
    timestr = strftime("%Y-%m-%d_%H-%M-%S", gmtime())
    filename = "ramp_tests/" + timestr + "_test1_board" + str(board)

    # turns on DAC circuit and cofigure it
    dac.on(board)
    selection.dac(board)
    dac.config()
    # turns on ADC circuit
    adc.on(board)

    # open file and name the fields in the first line
    log = open(filename + ".csv", "a+")
    log.write("original value;" + "value read\n")

    v2 = []
    # follow the ramp described by the vector v1

    selection.dac(board)
    while(1):
        for i in range(len(v1)):
            # write value in v1 in DAC:
#            selection.dac(board)
            dac.write(v1[i])
            # read value in ADC:
#            selection.adc(board)
#            measure = adc.read()
    #        v2.append(measure)
            # write data into .csv file
    #        log.write(str(v1[i]) + ";" + str(measure) + "\n")

    # update the file
    log.close()
    # plot graph
    import pylab
    plt.clf()
    plt.xlabel("data")
    plt.ylabel("binary value")
    pylab.plot(v1, '-b', label='curve to follow')
    pylab.plot(v2, '-r', label='data read')
    pylab.legend(loc='upper left')
    pylab.show()
    plt.show()
    plt.savefig('/root/scripts/' + filename)

    return v2
